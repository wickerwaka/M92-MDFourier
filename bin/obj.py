import struct
import math


num_codes = [ 24951, 24954, 24955, 24956, 24957, 24958, 24959, 24960, 24961, 24962 ]

class OBJ:
    def __init__(self, x, y, code, layer, cols=1, rows=1, color=0, prio=False, flip_x=False, flip_y=False):
        self.x = x
        self.y = y
        self.code = code
        self.layer = layer
        self.cols = cols
        self.rows = rows
        self.color = color
        self.prio = prio
        self.flip_x = flip_x
        self.flip_y = flip_y

    @staticmethod
    def from_bytes(bytes):
        a, b, c, d = struct.unpack("<HHHH", bytes)
        y = a & 0x1ff
        x = d & 0x1ff
        cols = 1 << ( ( a >> 11 ) & 3 )
        rows = 1 << ( ( a >>  9 ) & 3 )
        layer = ( ( a >>  13 ) & 7 )
        code = b
        color = c & 0x7f
        prio = ((c >> 7) & 1) == 1
        flip_x = ((c >> 8) & 1) == 1
        flip_y = ((c >> 9) & 1) == 1

        return OBJ(x, y, code, layer, cols, rows, color, prio, flip_x, flip_y)
    
    def to_bytes(self):
        cols = int(math.log2(self.cols))
        rows = int(math.log2(self.rows))
        a = ( ( self.layer & 7 ) << 13 ) | ( ( cols & 3 ) << 11 ) | ( ( rows & 3 ) << 9 ) | ( ( self.y & 0x1ff ) )
        b = self.code
        c = self.color & 0x7f
        if self.prio:
            c = c | ( 1 << 7 )
        if self.flip_x:
            c = c | ( 1 << 8 )
        if self.flip_y:
            c = c | ( 1 << 9 )
        d = self.x & 0x1ff
        return struct.pack("<HHHH", a, b, c, d)

    def __str__(self):
        return f"X:{self.x} Y:{self.y} Cols:{self.cols} Rows:{self.rows} Code:{self.code} Layer:{self.layer} Color:{self.color} Prio:{self.prio} FlipX:{self.flip_x} FlipY:{self.flip_y}"


def write_obj_data(bytes):
    with open('data/obj.bin', 'wb') as fp:
        fp.write(bytes)

def obj_sheet(index):
    obj_data = b''
    for y in range(180, 340, 16):
        for x in range(96, 416, 16):
            obj = OBJ(x, y, index, 3, color = 0)
            obj_data = obj_data + obj.to_bytes()
            index = index + 1
    return obj_data

def layer_test():
    obj_data = b''
    x = 160
    for num in range(0, 8):
        obj = OBJ(x, 288, num_codes[num], num, color = 2)
        obj_data = obj_data + obj.to_bytes()
        x = x + 16

    for num in range(0, 8):
        obj = OBJ(x, 280, num_codes[num], num, color = 0)
        obj_data = obj_data + obj.to_bytes()
        x = x - 16

    for num in range(0, 8):
        obj = OBJ(x, 260, num_codes[num], num, color = 2, prio = True)
        obj_data = obj_data + obj.to_bytes()
        x = x + 16


    return obj_data

write_obj_data(layer_test())

"""
for ofs in range(0, len(obj_data), 8):
    data = obj_data[ofs:ofs+8]
    obj = OBJ.from_bytes(data)
    data2 = obj.to_bytes()

    #if data != data2:
    #    print( data, data2 )

    print(obj)

obj_data = b'\
\x00\x00\x02\x00\x03\x00\x04\x00\xB0\x60\x06\x00\xA5\x00\x80\x01\xA8\x60\xAF\x63\xA5\x00\x68\x01\xA8\x60\x99\x63\xA5\x00\x58\x01\
\xA8\x60\xAF\x63\xA5\x00\x48\x01\xA8\x60\x99\x63\xA5\x00\x38\x01\xA8\x60\x77\x61\x82\x00\x18\x01\xA8\x60\x77\x61\x82\x00\x08\x01\
\xA8\x60\x81\x61\x82\x00\xF8\x00\xA8\x60\x7F\x61\x82\x00\xE8\x00\xA8\x60\x7E\x61\x82\x00\xD8\x00\xB0\x60\x06\x00\x82\x00\xD0\x00\
\xB0\x60\x06\x00\x82\x00\xC0\x00\xA8\x60\xAE\x63\x80\x00\x98\x00\xA8\x60\xBA\x63\x80\x00\x88\x00\xA8\x60\x80\x61\x80\x00\x78\x00\
\xC0\x60\xB5\x63\xA5\x00\x78\x01\xC0\x60\x76\x61\xA5\x00\x68\x01\xC0\x60\xB1\x63\xA5\x00\x58\x01\xC0\x60\x76\x61\xA5\x00\x48\x01\
\xC0\x60\xBA\x63\xA5\x00\x38\x01\xC0\x60\x77\x61\x82\x00\x18\x01\xC0\x60\x77\x61\x82\x00\x08\x01\xC0\x60\x7B\x61\x82\x00\xF8\x00\
\xC0\x60\x7D\x61\x82\x00\xE8\x00\xC0\x60\x7F\x61\x82\x00\xD8\x00\xC8\x60\x06\x00\x82\x00\xD0\x00\xC8\x60\x06\x00\x82\x00\xC0\x00\
\xC0\x60\xAE\x63\x80\x00\x98\x00\xC0\x60\xBA\x63\x80\x00\x88\x00\xC0\x60\x7F\x61\x80\x00\x78\x00\xD8\x60\xB4\x63\xA5\x00\x78\x01\
\xD8\x60\xAF\x63\xA5\x00\x68\x01\xD8\x60\xB3\x63\xA5\x00\x58\x01\xD8\x60\xBB\x63\xA5\x00\x48\x01\xD8\x60\xA7\x63\xA5\x00\x38\x01\
\xD8\x60\x77\x61\x82\x00\x18\x01\xD8\x60\x77\x61\x82\x00\x08\x01\xD8\x60\x7C\x61\x82\x00\xF8\x00\xD8\x60\x7F\x61\x82\x00\xE8\x00\
\xD8\x60\x80\x61\x82\x00\xD8\x00\xE0\x60\x06\x00\x82\x00\xD0\x00\xE0\x60\x06\x00\x82\x00\xC0\x00\xD8\x60\xAE\x63\x80\x00\x98\x00\
\xD8\x60\xBA\x63\x80\x00\x88\x00\xD8\x60\x7E\x61\x80\x00\x78\x00\xF0\x60\x99\x63\xA5\x00\x78\x01\xF0\x60\xBA\x63\xA5\x00\x68\x01\
\xF0\x60\xBB\x63\xA5\x00\x58\x01\xF0\x60\xB5\x63\xA5\x00\x48\x01\xF0\x60\xB1\x63\xA5\x00\x38\x01\xF0\x60\x77\x61\x82\x00\x18\x01\
\xF0\x60\x77\x61\x82\x00\x08\x01\xF0\x60\x7B\x61\x82\x00\xF8\x00\xF0\x60\x7D\x61\x82\x00\xE8\x00\xF0\x60\x81\x61\x82\x00\xD8\x00\
\xF8\x60\x06\x00\x82\x00\xD0\x00\xF8\x60\x06\x00\x82\x00\xC0\x00\xF0\x60\xAE\x63\x80\x00\x98\x00\xF0\x60\xBA\x63\x80\x00\x88\x00\
\xF0\x60\x7D\x61\x80\x00\x78\x00\x08\x61\xA7\x63\xA5\x00\x78\x01\x08\x61\x76\x61\xA5\x00\x68\x01\x08\x61\xBD\x63\xA5\x00\x58\x01\
\x08\x61\x76\x61\xA5\x00\x48\x01\x08\x61\xBB\x63\xA5\x00\x38\x01\x08\x61\x77\x61\x82\x00\x18\x01\x08\x61\x77\x61\x82\x00\x08\x01\
\x08\x61\x7F\x61\x82\x00\xF8\x00\x08\x61\x81\x61\x82\x00\xE8\x00\x08\x61\x82\x61\x82\x00\xD8\x00\x10\x61\x06\x00\x82\x00\xD0\x00\
\x10\x61\x06\x00\x82\x00\xC0\x00\x08\x61\xA3\x63\x80\x00\x98\x00\x08\x61\xB8\x63\x80\x00\x88\x00\x08\x61\x7C\x61\x80\x00\x78\x00\
\x20\x61\xB9\x63\xA5\x00\x78\x01\x20\x61\xB5\x63\xA5\x00\x68\x01\x20\x61\xB1\x63\xA5\x00\x58\x01\x20\x61\x99\x63\xA5\x00\x48\x01\
\x20\x61\xB9\x63\xA5\x00\x38\x01\x20\x61\x77\x61\x82\x00\x18\x01\x20\x61\x77\x61\x82\x00\x08\x01\x20\x61\x80\x61\x82\x00\xF8\x00\
\x20\x61\x77\x61\x82\x00\xE8\x00\x20\x61\x7A\x61\x82\x00\xD8\x00\x20\x61\x7A\x61\x82\x00\xC8\x00\x28\x61\x06\x00\x82\x00\xC0\x00\
\x20\x61\xA3\x63\x80\x00\x98\x00\x20\x61\xB4\x63\x80\x00\x88\x00\x20\x61\x7B\x61\x80\x00\x78\x00\x40\x61\x06\x00\xA5\x00\x80\x01\
\x38\x61\xB5\x63\xA5\x00\x68\x01\x38\x61\xB8\x63\xA5\x00\x58\x01\x38\x61\xAF\x63\xA5\x00\x48\x01\x38\x61\xAE\x63\xA5\x00\x38\x01\
\x38\x61\x77\x61\x82\x00\x18\x01\x38\x61\x77\x61\x82\x00\x08\x01\x38\x61\x7D\x61\x82\x00\xF8\x00\x38\x61\x81\x61\x82\x00\xE8\x00\
\x38\x61\x7B\x61\x82\x00\xD8\x00\x38\x61\x7A\x61\x82\x00\xC8\x00\x40\x61\x06\x00\x82\x00\xC0\x00\x38\x61\xBA\x63\x80\x00\x98\x00\
\x38\x61\xB9\x63\x80\x00\x88\x00\x38\x61\x7A\x61\x80\x00\x78\x00\x58\x61\xB9\x63\xA2\x00\x48\x01\x58\x61\xBA\x63\xA2\x00\x38\x01\
\x58\x61\xB5\x63\xA2\x00\x28\x01\x58\x61\xB2\x63\xA2\x00\x18\x01\x58\x61\xAF\x63\xA2\x00\x08\x01\x58\x61\xB6\x63\xA2\x00\xF8\x00\
\x60\x61\x06\x00\xA2\x00\xF0\x00\x58\x61\xBA\x63\xA2\x00\xD8\x00\x58\x61\xB9\x63\xA2\x00\xC8\x00\x58\x61\xA6\x63\xA2\x00\xB8\x00\
\x58\x61\x9A\x63\xA2\x00\xA8\x00\x9D\x60\x72\x61\xA5\x00\x88\x01\x4C\x6B\x42\x18\x24\x00\x5C\x00\x4C\x6B\x44\x18\x24\x00\x7C\x00\
\x4C\x6B\x44\x18\x24\x00\x7C\x00\x4C\x6B\x46\x18\x24\x00\x9C\x00\x4C\x6B\x46\x18\x24\x00\x9C\x00\x4C\x6B\x44\x18\x24\x00\xBC\x00\
\x4C\x6B\x44\x18\x24\x00\xBC\x00\x4C\x6B\x46\x18\x24\x00\xDC\x00\x4C\x6B\x46\x18\x24\x00\xDC\x00\x4C\x6B\x44\x18\x24\x00\xFC\x00\
\x4C\x6B\x44\x18\x24\x00\xFC\x00\x4C\x6B\x46\x18\x24\x00\x1C\x01\x4C\x6B\x46\x18\x24\x00\x1C\x01\x4C\x6B\x64\x18\x24\x00\x3C\x01\
\x4C\x6B\x64\x18\x24\x00\x3C\x01\x80\x61\x06\x00\x24\x00\xDC\x00\x80\x61\x06\x00\x24\x00\xDC\x00\xA8\x6A\xB6\x01\x21\x01\x5B\x01\
\x1B\x6B\x00\x00\x19\x00\x9D\x00\x1B\x6B\x00\x00\x19\x00\x9D\x00\xB8\x6A\x00\x00\x15\x00\x23\x01\xB8\x6A\x00\x00\x15\x00\x23\x01\
\x3B\x61\x06\x00\x18\x00\xAD\x00\x3B\x61\x06\x00\x18\x00\xAD\x00\x1B\x61\x06\x00\x18\x00\xAD\x00\xD8\x60\x06\x00\x18\x00\x33\x01\
\xB8\x60\x06\x00\x18\x00\x33\x01\x2B\x6B\xB0\x0B\x1A\x00\x9D\x00\x13\x69\x82\x0B\x1A\x00\x9D\x00\x13\x69\x82\x0B\x1A\x00\x9D\x00\
\xC8\x6A\xB0\x0B\x16\x00\x23\x01\xC8\x6A\xB0\x0B\x16\x00\x23\x01\xB0\x68\x82\x0B\x16\x00\x23\x01\xB0\x68\x82\x0B\x16\x00\x23\x01\
\x75\x63\x68\x15\x23\x00\x4D\x00\x75\x63\x68\x15\x23\x00\x4D\x00\x65\x65\x6C\x15\x23\x00\x3D\x00\xA8\x6A\x00\x16\x1B\x00\x7E\x01\
\x64\x6B\x84\x15\x23\x00\x7F\x00\x64\x6B\x84\x15\x23\x00\x7F\x00\x64\x6B\x84\x15\x23\x00\xA7\x00\x64\x6B\x84\x15\x23\x00\xA7\x00\
\x64\x6B\x84\x15\x23\x00\xCF\x00\x64\x6B\x84\x15\x23\x00\xCF\x00\x64\x6B\x84\x15\x23\x00\xF7\x00\x64\x6B\x84\x15\x23\x00\xF7\x00\
\x64\x6B\x84\x15\x23\x00\x1F\x01\x64\x6B\x84\x15\x23\x00\x1F\x01\x6A\x63\x68\x15\x23\x00\x73\x00\x6A\x63\x68\x15\x23\x00\x73\x00\
\x5A\x65\x6C\x15\x23\x00\x63\x00\xAD\x60\xFD\x00\x17\x00\x27\x01\xAD\x60\xEC\x00\x17\x00\x37\x01\x0C\x61\xEC\x00\x17\x00\xB0\x00\
\xD5\x60\xEC\x00\x17\x00\x35\x01\x33\x61\x90\x03\x1C\x02\xF5\x00\x33\x69\x84\x03\x1C\x02\xD5\x00\x13\x61\x90\x03\x1C\x00\xF5\x00\
\x13\x61\x90\x03\x1C\x00\xF5\x00\x13\x69\x84\x03\x1C\x00\xD5\x00\x27\x61\x90\x03\x1C\x02\xFD\x00\x27\x61\x90\x03\x1C\x02\xFD\x00\
\x27\x69\x84\x03\x1C\x02\xDD\x00\x1F\x61\x90\x03\x1C\x00\xFD\x00\x1F\x61\x90\x03\x1C\x00\xFD\x00\x1F\x69\x84\x03\x1C\x00\xDD\x00\
\x23\x61\x90\x03\x1C\x00\x05\x01\x23\x61\x90\x03\x1C\x00\x05\x01\x23\x69\x84\x03\x1C\x00\xE5\x00\x3B\x61\xEC\x00\x17\x00\xB0\x00\
\x3B\x61\xEC\x00\x17\x00\xB0\x00\xC0\x60\x82\x04\x1F\x00\x7B\x01\xC0\x60\x83\x04\x1F\x00\x6B\x01\xC0\x60\x81\x04\x1F\x00\x5B\x01\
\xD0\x62\x66\x04\x1F\x02\x73\x01\xC0\x62\x5E\x04\x1F\x02\x63\x01\x10\x63\x66\x04\x1F\x02\x73\x01\x00\x63\x5E\x04\x1F\x02\x63\x01\
\xC0\x60\xC7\x00\x17\x00\x86\x01\x23\x61\xB8\x03\x17\x00\x4B\x01\x00\xE0\x57\x03\x58\x03\x59\x03\x00\xE0\x5B\x03\x5C\x03\x5D\x03\
\x00\xE0\x5F\x03\x60\x03\x61\x03\x00\xE0\x63\x03\x65\x03\x66\x03\x00\xE0\x68\x03\x69\x03\x6A\x03\x00\xE0\x6C\x03\x6D\x03\x6E\x03\
\x00\xE0\x70\x03\x71\x03\x73\x03\x00\xE0\x75\x03\x76\x03\x77\x03\x00\xE0\x79\x03\x7A\x03\x7B\x03\x00\xE0\x7D\x03\x7E\x03\x7F\x03\
\x00\xE0\x82\x03\x83\x03\x84\x03\x00\xE0\x86\x03\x87\x03\x88\x03\x00\xE0\x8A\x03\x8B\x03\x8C\x03\x00\xE0\x8F\x03\x90\x03\x91\x03\
\x00\xE0\x93\x03\x94\x03\x95\x03\x00\xE0\x97\x03\x98\x03\x99\x03\x00\xE0\x9B\x03\x9D\x03\x9E\x03\x00\xE0\xA0\x03\xA1\x03\xA2\x03\
\x00\xE0\xA4\x03\xA5\x03\xA6\x03\x00\xE0\xA8\x03\xA9\x03\xAB\x03\x00\xE0\xAD\x03\xAE\x03\xAF\x03\x00\xE0\xB1\x03\xB2\x03\xB3\x03\
\x00\xE0\xB5\x03\xB6\x03\xB7\x03\x00\xE0\xBA\x03\xBB\x03\xBC\x03\x00\xE0\xBE\x03\xBF\x03\xC0\x03\x00\xE0\xC2\x03\xC3\x03\xC4\x03\
\x00\xE0\xC7\x03\xC8\x03\xC9\x03\x00\xE0\xCB\x03\xCC\x03\xCD\x03\x00\xE0\xCF\x03\xD0\x03\xD1\x03\x00\xE0\xD3\x03\xD5\x03\xD6\x03\
\x00\xE0\xD8\x03\xD9\x03\xDA\x03\x00\xE0\xDC\x03\xDD\x03\xDE\x03\x00\xE0\xE0\x03\xE1\x03\xE3\x03\x00\xE0\xE5\x03\xE6\x03\xE7\x03\
\x00\xE0\xE9\x03\xEA\x03\xEB\x03\x00\xE0\xED\x03\xEE\x03\xEF\x03\x00\xE0\xF2\x03\xF3\x03\xF4\x03\x00\xE0\xF6\x03\xF7\x03\xF8\x03\
\x00\xE0\xFA\x03\xFB\x03\xFC\x03\x00\xE0\xFF\x03\x00\x04\x01\x04\x00\xE0\x03\x04\x04\x04\x05\x04\x00\xE0\x07\x04\x08\x04\x09\x04\
\x00\xE0\x0B\x04\x0D\x04\x0E\x04\x00\xE0\x10\x04\x11\x04\x12\x04\x00\xE0\x14\x04\x15\x04\x16\x04\x00\xE0\x18\x04\x19\x04\x1B\x04\
\x00\xE0\x1D\x04\x1E\x04\x1F\x04\x00\xE0\x21\x04\x22\x04\x23\x04\x00\xE0\x25\x04\x26\x04\x27\x04\x00\xE0\x2A\x04\x2B\x04\x2C\x04\
\x00\xE0\x2E\x04\x2F\x04\x30\x04\x00\xE0\x32\x04\x33\x04\x34\x04\x00\xE0\x37\x04\x38\x04\x39\x04\x00\xE0\x3B\x04\x3C\x04\x3D\x04\
\x00\xE0\x3F\x04\x40\x04\x41\x04\x00\xE0\x43\x04\x45\x04\x46\x04\x00\xE0\x48\x04\x49\x04\x4A\x04\x00\xE0\x4C\x04\x4D\x04\x4E\x04'
"""



